---
import Icon from "@components/primitives/icon/icon.astro";
import RenderBlock from "@components/utils/renderBlock.astro";

const { href, text, class: className, defaultOpen = false, navBlocks = [], ...rest } = Astro.props;

const htmlAttributes = Object.fromEntries(
  Object.entries(rest).filter(([key]) => !key.startsWith("_"))
);

const hasChildren = Astro.slots.has("default") || navBlocks.length > 0;
const dropdownId = `dropdown-toggle-${crypto.randomUUID()}`;
const contentId = `dropdown-content-${crypto.randomUUID()}`;
const isCurrentPage = href === Astro?.url?.pathname;
---

<li class:list={["nav-item", className, hasChildren ? "has-children" : null]} {...htmlAttributes}>
  {
    hasChildren ? (
      <>
        <input
          type="checkbox"
          id={dropdownId}
          class="nav-item-toggle"
          aria-expanded={defaultOpen ? "true" : "false"}
          aria-controls={contentId}
          autocomplete="off"
          checked={defaultOpen}
        />
        <label
          for={dropdownId}
          class="nav-item-trigger"
          role="button"
          aria-controls={contentId}
          tabindex="0"
        >
          {text}
          <slot name="text" />
          <span class="nav-item-icon">
            <Icon name="chevron-right" size="none" aria-hidden="true" />
          </span>
        </label>
        <div
          id={contentId}
          class="nav-item-content"
          role="region"
          aria-label={`${text} submenu`}
          aria-hidden={!defaultOpen}
        >
          <slot />
          <RenderBlock contentBlocks={navBlocks} />
        </div>
      </>
    ) : (
      <a href={href} aria-current={isCurrentPage ? "page" : undefined}>
        {text}
        <slot name="text" />
      </a>
    )
  }
</li>

<script>
  function closeAllDropdownsInParent(navItem: HTMLElement) {
    const navRoot = navItem.closest(".nav-root");
    if (!navRoot) return;

    navRoot.querySelectorAll(".nav-item-toggle").forEach((toggle) => {
      if (toggle instanceof HTMLInputElement) {
        toggle.checked = false;
        updateAriaStates(toggle, false);
      }
    });
  }

  function updateAriaStates(toggle: HTMLInputElement, isExpanded: boolean) {
    const content = document.getElementById(toggle.getAttribute("aria-controls") || "");

    if (content) {
      content.setAttribute("aria-hidden", (!isExpanded).toString());
    }
  }

  function setupDropdowns() {
    document.querySelectorAll(".nav-item-toggle").forEach((toggle) => {
      toggle.addEventListener("change", (e) => {
        const target = e.target as HTMLInputElement;
        const navItem = target.closest(".nav-item") as HTMLElement;

        updateAriaStates(target, target.checked);

        if (target.checked) {
          closeAllDropdownsInParent(navItem);
          target.checked = true;
          updateAriaStates(target, true);
        }
      });
    });

    // Add keyboard support for labels
    document.querySelectorAll(".nav-item-trigger").forEach((trigger) => {
      trigger.addEventListener("keydown", (e) => {
        const keyEvent = e as KeyboardEvent;
        if (keyEvent.key === "Enter" || keyEvent.key === " ") {
          e.preventDefault();
          const checkbox = document.getElementById(
            trigger.getAttribute("for") || ""
          ) as HTMLInputElement;
          if (checkbox) {
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event("change"));
          }
        }
      });
    });
  }

  function initializeAriaStates() {
    document.querySelectorAll(".nav-item-toggle").forEach((toggle) => {
      if (toggle instanceof HTMLInputElement) {
        updateAriaStates(toggle, toggle.checked);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupDropdowns();
    initializeAriaStates();
  });
</script>
